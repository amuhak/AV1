<!DOCTYPE html>
<html lang="en">
<head>
    <title>AV1 Converter</title>
    <script>
        async function uploadFile() {
            let formData;
            const file = document.getElementById('fileInput').files[0];
            const chunkSize = 90 * 1024 * 1024; // 90MB chunks
            let chunks = Math.ceil(file.size / chunkSize);

            // Calculate hash
            const hash = await calculateHash(file);

            const uploadChunk = async (i) => {
                const start = i * chunkSize;
                const end = Math.min(file.size, start + chunkSize);
                const chunk = file.slice(start, end);

                const formData = new FormData();
                formData.append("Hash", hash);
                formData.append("FileName", file.name);
                formData.append("Chunk", chunk);
                formData.append("Index", i);
                formData.append("TotalChunks", chunks);

                await fetch('/upload-chunk', {
                    method: 'POST',
                    body: formData
                });
            };

            await Promise.all(
                Array.from({length: chunks}, (_, i) => uploadChunk(i))
            );

            formData = new FormData();
            formData.append("FileName", file.name);
            formData.append("NoOfChunks", chunks);
            formData.append("Hash", hash);
            await fetch('/combine', {
                method: 'POST',
                body: formData
            });


            formData = new FormData();
            formData.append("Hash", hash);
            formData.append("FileName", file.name);
            let process = await fetch('/process', {
                method: 'POST',
                body: formData
            });
            process = await process.json();
            chunks = process.noOfParts;
            try {
                const downloadChunk = async (i) => {
                    const response = await fetch(`/downloads/${hash}/${i}`);
                    if (!response.ok) {
                        throw new Error(`Failed to download part ${i}`);
                    }
                    return await response.blob();
                };

                const parts = await Promise.all(
                    Array.from({length: chunks}, (_, i) => downloadChunk(i))
                );

                const combinedBlob = new Blob(parts, {type: "application/octet-stream"});
                const downloadUrl = URL.createObjectURL(combinedBlob);
                const downloadButton = document.createElement('a');
                downloadButton.href = downloadUrl;
                downloadButton.download = `${hash}_av1.mp4`;  // You might want to set a more specific filename
                downloadButton.textContent = 'Download Combined File';
                downloadButton.className = 'download-button';
                // Add button to document
                document.body.appendChild(downloadButton);
                // Cleanup
                downloadButton.onclick = () => {
                    setTimeout(() => URL.revokeObjectURL(downloadUrl), 100);
                };
            } catch (error) {
                console.error("Error downloading and combining file:", error);
                alert("An error occurred while preparing your download. Please try again.");
            }
        }

        async function calculateHash(file) {
            const buffer = await file.arrayBuffer();
            const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }
    </script>
</head>
<body>
<h1>Upload Video for AV1 Conversion</h1>
<input type="file" id="fileInput" accept="video/*"/>
<button onclick="uploadFile()">Convert to AV1</button>
</body>
</html>
